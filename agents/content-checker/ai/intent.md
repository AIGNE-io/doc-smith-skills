# Content Checker Agent 功能意图

## 功能概述

文档内容校验和修复工具，用于在文档生成后检查文档内容的完整性、准确性和规范性。

## 功能意图

文档生成过程中可能出现各种问题：文档文件缺失、元数据格式错误、内部链接断裂、图片路径错误、标题层级不规范等。这些问题会影响文档的可用性和用户体验。Content Checker Agent 提供自动化的多层次检查机制，能够发现这些问题并在可能的情况下自动修复，确保生成的文档符合质量标准。

## 工作流程

Content Checker 在文档生成流程的最后阶段执行：

1. **文档生成完成** → Content Checker Agent 被调用
2. **Layer 0: 无效文档清理** → 删除文件系统中存在但不应该存在的文档
3. **Layer 1: 结构检查** → 验证文档文件夹、.meta.yaml、语言文件的存在性和格式
4. **Layer 2-4: 内容检查** → 逐个检查文档内容、链接、图片
5. **自动修复** → 如果启用且存在可修复错误，尝试自动修复
6. **返回结果** → 返回检查报告和统计信息

## 核心能力

1. **无效文档清理**：检查前自动删除不应存在的文档文件
2. **多层次检查**：从文件存在性到内容细节的全面检查
3. **错误分类**：区分致命错误、可修复错误和警告
4. **链接验证**：检查内部文档链接的有效性
5. **图片验证**：验证本地图片存在性和远程图片可访问性
6. **Sources 绝对路径支持**：解析 `/sources/<name>/...` 虚拟路径到物理路径并验证
7. **选择性检查**：支持指定特定文档进行检查，或检查所有文档
8. **自动修复**：支持自动修复可修复的错误（当前版本预留扩展）

## 输入输出

### 输入

- 可选输入：
  - `docs`: 要检查的文档路径数组，如 `["/overview", "/api/introduction"]`，如果不提供则检查所有文档

- 自动获取：
  - 从 `PATHS` 常量自动获取文档结构文件路径 (`planning/document-structure.yaml`)
  - 从 `PATHS` 常量自动获取文档目录路径 (`docs/`)
  - `autoFix` 默认为 `true`
  - `checkRemoteImages` 默认为 `true`

### 输出

- 输出内容：检查结果对象
  - `success`: 检查是否成功执行
  - `valid`: 文档内容是否有效
  - `message`: 格式化的检查报告
  - `errors`: 错误列表（分类为 fatal、fixable、warnings）
  - `stats`: 统计信息
  - `fixed`: 是否执行了修复
  - `fixedCount`: 修复的错误数量
  - `cleaned`: 清理统计（删除的无效文档文件夹数量、删除的无效语言文件数量）

- 输出格式：结构化对象，包含详细的错误信息和操作建议

## 约束条件

### 必须遵循的规范

1. **无效文档清理规则**：
   - 扫描 docs/ 目录下的所有文档文件夹
   - 删除不在 document-structure.yaml 中定义的文档文件夹
   - 对于每个有效的文档文件夹，读取 `.meta.yaml` 获取有效语言列表
   - 删除 `.meta.yaml` 中未定义的语言版本文件（如 `claude-code.md` 不在 languages 列表中）
   - 清理操作在检查前执行，确保后续检查不会被无效文件干扰

2. **文档结构规范**：
   - 文档文件夹必须包含 `.meta.yaml` 文件
   - `.meta.yaml` 必须包含 `kind`、`source`、`default` 字段
   - `kind` 字段必须为 `"doc"`
   - 至少存在一个语言版本文件（如 `zh.md`、`en.md`）

3. **内容规范**：
   - 文档内容不能为空（去除标题后至少 50 字符）
   - 标题层级不能跳级（H1 → H2 → H3，不能 H1 → H3）
   - 内部链接必须指向存在的文档
   - 本地图片必须存在于指定路径

4. **检查规则**：
   - 跳过代码块中的链接和图片
   - 忽略外部链接的有效性检查
   - 远程图片通过 HTTP HEAD 请求检查可访问性（3秒超时）

5. **Sources 绝对路径规则**：
   - 识别 `/sources/...` 格式的图片路径
   - 从 config.yaml 加载 sources 配置
   - 依次在每个配置的 source 中查找图片：
     - `local-path`: 相对于 workspace 的路径
     - `git-clone`: workspace/sources/<name>/ 目录
   - 返回第一个存在的物理路径

### 职责边界

- **必须执行**：
  - 清理无效文档：删除不在 document-structure.yaml 中的文档文件夹
  - 清理无效语言文件：删除 `.meta.yaml` 中未定义的语言版本文件
  - 读取并解析文档结构文件
  - 验证文档文件和元数据的存在性和格式（所有文档或指定文档）
  - 检查文档内容中的链接和图片
  - 提供详细的错误报告和修复建议
  - 当 `docs` 参数提供时，仅检查指定的文档路径

- **不应执行**：
  - 不修改 document-structure.yaml 文件内容
  - 不生成新的文档内容
  - 不执行文档翻译或内容转换
  - 当前版本不实现自动修复（预留扩展点）

- **协作方式**：
  - 依赖 `document-paths.mjs` 工具收集文档路径
  - 依赖 `sources-path-resolver.mjs` 解析 `/sources/...` 绝对路径
  - 依赖 `config.mjs` 加载 config.yaml 中的 sources 配置
  - 使用 `agent-constants.mjs` 中的路径常量
  - 作为文档生成流程的最后验证步骤

## 预期结果

### 成功标准

1. **检查通过**：
   - 所有文档文件和文件夹存在
   - 所有 `.meta.yaml` 格式正确且包含必需字段
   - 所有内部链接有效
   - 所有本地图片存在
   - 文档内容充实且标题层级规范

2. **错误处理得当**：
   - 清晰分类错误类型（fatal/fixable/warnings）
   - 提供具体的错误位置和修复建议
   - 统计信息准确完整

## 错误处理

### 常见错误

1. **文件不存在**：文档结构文件或文档目录不存在
2. **文档文件夹缺失**：结构中定义的文档文件夹未生成
3. **元数据错误**：`.meta.yaml` 缺失、格式错误或缺少必需字段
4. **语言文件缺失**：没有任何语言版本文件或缺少 default/source 语言
5. **内容问题**：空文档、标题跳级
6. **链接问题**：内部链接死链、路径超出根目录
7. **图片问题**：本地图片不存在、远程图片无法访问
8. **Sources 路径问题**：无法解析的 source name、物理路径上图片不存在

### 处理策略

1. **Layer 0 清理（无效文档）**：
   - 静默删除无效的文档文件夹和语言文件
   - 在返回结果中报告删除数量
   - 不视为错误，而是预处理步骤

2. **Layer 1 错误（文件结构）**：
   - 立即返回，提供明确的错误原因和解决方案
   - 提示可能的原因（路径错误、文件名错误、未生成）

3. **Layer 2-4 错误（内容问题）**：
   - 收集所有错误，完整报告
   - 提供具体的错误位置（文档路径、语言文件、行号）
   - 给出操作建议

4. **自动修复**：
   - 当前版本保留扩展点但不实现自动修复
   - 未来可添加：链接格式修正、图片路径修正、Markdown 格式优化

5. **缓存机制**：
   - 远程图片检查结果缓存，避免重复请求


### 集成方式

- **作为 Function Agent 使用**：
  - 在 skill 或其他 agent 中通过 `import checkContent from './agents/content-checker/index.mjs'` 调用
  - 返回结构化的检查结果对象
  - 支持两种调用方式：
    - 检查所有文档：`checkContent()`
    - 检查指定文档：`checkContent({ docs: ["/overview", "/api/introduction"] })`

- **无需 skills-entry 配置**：
  - 作为内部工具使用，不直接暴露为 skill
  - 通过其他 skill（如 doc-smith）间接调用

---
**注意**：本文档描述功能意图，不包含具体实现细节。
