# Changeset 文件理解与执行指南

## 核心定位

Changeset 是**批量反馈的结构化载体**，格式自由，自然语言描述。
用户通过 Changeset 提出的修改请求都直接执行， 不需要向用户二次确认。
ChangeSet 文件应该在仓库中保留，记录历史修改要求。

**包含内容**：
- Summary（摘要）
- Global Semantic Changes（全局语义修改）
- Structural Rewrite Requests（局部结构性重写）
- Additional Data/References（补充资料）
- Clarifications/Corrections（需求澄清）
- Acceptance Criteria（验收标准）

**注意**：PATCH 推荐直接标记在文档正文中，不要求写在 changeset 中。

## 六大类型

### 0. Summary（摘要）

用 1–3 句说明变更范围与重点。

**要点**：
- 用于规划步骤与排序
- 不提供位置锚点时，不要扩大修改范围
- 优先依赖下面更具体的条目

**示例**：`本次为全局语义调整 + 局部重写：统一术语，补充快速开始章节`

---

### 1. Global Semantic Changes（全局语义修改）

跨文档的术语、风格、命名一致性修改。

**典型场景**：术语统一、风格调整、叙述视角统一、格式规范。

**要点**：
- 优先级高：先于局部改写执行
- 避免过度改写：只做最小必要修改
- 冲突时以更具体的局部要求为准

**示例**：
```
1. 术语统一："API" → "API 接口"、"blocklet" → "Blocklet"
2. 风格调整：删除第一人称，保持中立第三人称
3. 格式规范：代码块统一添加语言标识符
```

---

### 2. Structural Rewrite Requests（局部结构性重写）

对特定章节/段落提出重写或重构请求，对文档结构提出调整请求，描述目标但不给出确定文本。

如果涉及文档结构的修改，需要参考以下信息：
- 文档结构数据结构参考： `document-structure-schema.md`
- 向用户展示确认文档结构请参考： `structure-confirmation-guide.md`

阅读参考文件需在 task 中记录，在执行到相应 task 时阅读这些参考文件。

**位置锚点**：章节标题、段落关键词、文件路径。

**推荐字段**（自然语言）：
- Target（目标位置）
- Issue（问题描述）
- Rewrite Goal（改写目标）
- Suggested Outline（可选）
- Materials（可选）

**要点**：
- 只修改目标范围，不扩散到无关章节
- 锚点不精确时，先检索定位最匹配段落
- PATCH 优先：先执行 PATCH，再在结果基础上重写
- 保持链接、术语、结构一致性

**示例**：
```
Target: overview.md, Introduction 章节
Issue: 缺少项目背景
Rewrite Goal: 补充项目定位、核心价值、适用场景
```

---

### 3. Additional Data / References（补充资料）

新增或修正的参考信息，提供更准确的上下文。

**典型场景**：附加文档、术语表更新、产品说明、纠正错误。

**要点**：
- 作为参考上下文，用于修正事实与补齐遗漏
- 只在与现有内容矛盾或能显著提升准确性时才改
- 信息不足时标注问题，不要编造

**示例**：
```
1. 术语表更新：`Workspace` → 独立的文档工作空间
2. 参考文档：/path/to/api-v2.md
```

---

### 4. Clarifications / Corrections（需求澄清）

对最初目标、范围、约束、受众等的理解修正，改变判断标准。

**典型场景**：受众变更、输出形态澄清、语气调整、范围修正。

**要点**：
- **最高优先级**：覆盖旧的隐含前提
- 大范围重构时，优先调整入口段和目录结构
- 与其他类型冲突时，以澄清为准
- 一旦存在，必须重新审视全文是否存在与之冲突的内容，但只允许进行最小必要修改，不得引入无关变更。

**示例**：
```
1. 受众修正：从技术开发者改为产品经理
2. 输出澄清："全自动"指 patch 自动合并，非跳过人工审核
3. 语气调整：从营销宣传改为朴实技术说明
```

---

### 5. Acceptance Criteria（验收标准）

判断"是否改对了"的检查清单，逐条勾选。

**要点**：
- 生成完成后必须自检，并在摘要中逐条对齐
- 未满足项需说明原因和下一步建议

**示例**：
```
- [ ] 全局术语统一：API、Blocklet、Workspace 一致
- [ ] 快速开始章节已补充环境要求
- [ ] 文档无重复段落、无矛盾
- [ ] 所有链接有效
- [ ] 代码块都有语言标识符
```

---

## 执行顺序

```
1. 找到 changeset 文件 → 提取用户信息中的文件信息，使用 pattern 搜索 changeset 文件
1. 读取 changeset 文件 → 建立全局约束
2. 扫描文档 → 定位所有 PATCH
3. 执行 PATCH → 确定性变更
4. 应用全局语义修改 → 遍历所有文档
5. 执行局部结构重写 → 利用 Additional Data
6. 一致性检查 → 术语、风格、结构
7. 输出摘要 → 对齐 Acceptance Criteria
```

## 冲突处理

| 冲突类型 | 处理原则 |
|---------|---------|
| **澄清 vs 其他** | 澄清优先（最高优先级） |
| **全局 vs 局部** | 局部优先（更具体） |
| **PATCH vs 重写** | PATCH 先执行 |
| **规则冲突** | 询问用户 |

## 处理歧义

遇到模糊描述、范围不明、规则冲突时：先搜索定位，说明问题，询问用户，不要编造。
