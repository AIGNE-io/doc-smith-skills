---
name: doc-smith
description: "从工作区数据源生成和更新全面的文档，包括代码仓库、文本文件和媒体资源。当用户请求以下操作时使用此技能：(1) 从代码或文件创建或生成文档，(2) 构建文档结构或文档详情，(3) 分析工作区内容以生成有组织的文档，(4) 将代码/项目内容转换为可读文档，(5) 更新、修改或改进已有文档，(6) 应用术语统一、风格调整等全局修改，(7) 重写文档的特定章节或段落，(8) 处理 changeset 文件或 PATCH 标记的修改请求。支持技术文档、用户指南、API 参考和一般文档需求的生成与维护。"
---

# DocSmith

从工作区数据源生成和更新结构化文档。

## 概述

DocSmith 分析工作区内容（代码、文件、媒体）并生成：
1. 用户意图描述（`user_intent.md`）
2. 文档结构计划（`document_structure.yaml`）
3. 按层次组织的 Markdown 文档文件

所有输出都创建在 `.aigne/doc-smith/` 目录中。

## 使用场景

### 场景 A：生成新文档

当 `.aigne/doc-smith/docs/` 目录不存在或用户明确要求重新生成时，使用 **文档生成流程**（步骤 1-7）。

**适用情况：**
- 首次为项目生成文档
- 完全重建文档结构
- 用户说"重新生成所有文档"

### 场景 B：更新已有文档

当 `.aigne/doc-smith/docs/` 目录已存在且用户要求修改时，使用 **文档更新流程**（步骤 8）。

**适用情况：**
- 用户提出自然语言修改请求（如"统一术语"、"补充章节"、"修正错误"）
- 用户提供 changeset 文件路径
- 文档中存在 `:::PATCH` 标记
- 用户说"更新文档"、"修改文档"、"应用修改"

## 工作流程

按以下步骤依次执行：

### 1. 分析工作区

探索工作区以了解可用的数据源：

```bash
# 查找相关文件
find . -type f -name "*.md" -o -name "*.py" -o -name "*.js" # 等

# 或使用 Glob/Grep 工具发现：
# - 包含文档的代码文件
# - README 文件
# - 现有文档
# - 媒体资源（图片、视频）
```

**需要收集的关键信息：**
- 项目目的和结构
- 主要模块/组件
- 现有文档
- 代码注释和文档字符串
- 可引用的媒体资源

### 2. 推断用户意图

**⚠️ 这是文档规划的关键前置步骤。**

基于工作区分析结果，自动推断并生成用户意图描述。用户意图将指导后续的文档结构规划，避免生成大而全、不聚焦的文档。

**推断内容：**
1. **目标用户**：谁会阅读这份文档？（开发者、最终用户、运维人员等）
2. **主要使用场景**：用户在什么情况下查阅文档？
3. **文档侧重点**：使用指南型、参考手册型、快速上手型或架构说明型

**生成文件：** `.aigne/doc-smith/output/user_intent.md`

**交互策略：**
- 自动生成用户意图，向用户展示完整意图
- **使用 AskUserQuestion 工具** 询问用户确认：
  - 问题："用户意图是否符合您的需求？"
  - 选项："✅ 确认，开始规划文档结构"（只需提供此选项，系统会自动添加 Other 选项供用户输入调整需求）
- 如果用户通过 Other 提供调整需求，更新意图后重新展示并再次确认
- 支持多轮调整，直到用户确认
- 用户确认后才进入下一步（规划文档结构）

**详细指南：** 参见 [user_intent_guide.md](references/user_intent_guide.md)，包含：
- 如何推断目标用户、使用场景和文档侧重点
- user_intent.md 模板和示例
- 交互策略和示例交互流程

### 3. 规划文档结构

**基于用户意图**，设计聚焦且实用的文档层次结构。

**核心原则：**
- 目标用户决定文档类型
- 使用场景决定文档范围
- 侧重点决定详细程度

**规划策略：**
- **最小必要原则**：只规划用户意图中明确需要的文档
- **聚焦核心场景**：优先覆盖用户的主要使用场景
- **适度深度**：根据用户需求决定嵌套层级

**拆分判断：**
- 应该拆分：内容量大、独立性强、无重复、可独立查阅
- 不应拆分：内容单薄、有重复依赖、顺序步骤、父文档变空壳

**详细指南：** 参见 [structure_planning_guide.md](references/structure_planning_guide.md)，包含：
- 常见问题及避免方法
- 详细的拆分判断标准和清单
- 正确与错误的示例对比

### 4. 生成 document_structure.yaml

按照 schema 创建 `.aigne/doc-smith/output/document_structure.yaml`。

**结构评估：** 使用 [structure_planning_guide.md](references/structure_planning_guide.md) 中的评估清单权衡是否拆分。

**Schema 参考：** 完整格式和示例请参见 [document_structure_schema.md](references/document_structure_schema.md)。

**快速模板：**
```yaml
project:
  title: "项目名称"
  description: "项目简要描述"

documents:
  - title: "文档标题"
    description: "此文档涵盖的内容"
    path: "/filename.md"
    sourcePaths:
      - "path/to/source/file.py"
    icon: "lucide:icon-name"  # 仅顶层文档需要
    children:  # 可选的嵌套
      - title: "嵌套文档"
        description: "详细信息"
        path: "/section/nested.md"
        sourcePaths: []
```

**关键要求：**
- `path`：必须以 `/` 开头，以 `.md` 结尾
- `sourcePaths`：相对路径，不要使用 `workspace:` 前缀，如果没有则使用 `[]`
- `icon`：顶层文档必需，格式为 `lucide:icon-name`，参见 https://lucide.dev/icons
- 子文档不需要 icons

**⚠️ 生成 YAML 后，不要立即开始生成文档内容，先进入确认步骤。**

### 5. 确认文档结构

**⚠️ 这是避免浪费资源的关键检查点。**

生成 `document_structure.yaml` 后，必须先向用户展示规划的文档结构，获得确认后再继续。

**展示内容：**
- 文档总数
- 文档层次结构（使用 emoji 和缩进）
- 每个文档的标题、描述和主要源文件

**交互策略：**
- 展示文档结构后，**使用 AskUserQuestion 工具** 询问用户确认：
  - 问题："文档结构是否符合您的需求？"
  - 选项："✅ 确认，开始生成文档"（只需提供此选项，系统会自动添加 Other 选项供用户输入调整需求）
- 如果用户通过 Other 提供调整需求，更新结构后重新展示并再次确认
- 支持多轮调整，直到用户确认满意

**处理反馈类型：**
1. 删除文档
2. 添加文档
3. 调整层次（合并/拆分/调整父子关系）
4. 修改内容范围

**关键原则：**
- 每次修改后必须重新展示完整结构
- 支持多轮调整，直到用户确认满意
- 绝对不要在用户确认前开始生成文档内容

**详细指南：** 参见 [structure_confirmation_guide.md](references/structure_confirmation_guide.md)，包含：
- 展示格式示例和 emoji 使用建议
- 处理各类用户反馈的详细操作步骤
- 完整的多轮交互示例

### 6. 生成文档内容

为结构中的每个文档在 `.aigne/doc-smith/docs/` 中创建 markdown 文件：

**文件命名：** 使用 YAML 中的 `path`（例如：`/api/auth.md` → `docs/api/auth.md`）

**内容指南：**
- 从 `sourcePaths` 列出的文件中提取信息
- 根据需要读取更多文件内容补充上下文
- 使用相对路径或 markdown 语法引用媒体资源
- 编写清晰、结构化的内容，包含标题和章节

**示例：**
```markdown
# 身份验证

学习如何验证 API 请求。

## 概述
[从源文件中提取]

## 方法
[文档化身份验证方式]

## 示例
[来自 sourcePaths 的代码片段]

---
**相关：** [API 参考](/api.md) | [快速开始](/getting-started.md)
```

### 7. 链接相关文档

**在文档开头和结尾**，添加指向相关文档的导航链接：

```markdown
<!-- 开头 -->
**前置条件：** [快速开始](/getting-started.md)

[主要内容]

<!-- 结尾 -->
---
**相关文档：**
- [API 参考](/api.md)
- [示例](/examples.md)
- [故障排查](/troubleshooting.md)
```

**链接策略：**
- 开头：前置条件、父主题
- 结尾：相关主题、下一步、子文档
- 使用与文档 `path` 值匹配的相对路径

### 8. 更新已有文档

**⚠️ 仅当 `.aigne/doc-smith/docs/` 已存在时执行此步骤。**

当需要修改已生成的文档时，支持三种输入方式和三种反馈类型：

#### 三种输入方式

**方式 1：自然语言修改请求**
- 用户直接描述需要修改的内容
- 示例："将所有 API 改为 API 接口"、"补充环境要求说明"

**方式 2：Changeset 文件**
- 用户提供结构化的批量修改文件
- 示例："应用 changeset-2025-12-23.md"
- 格式规范：参见 [changeset_schema.md](references/changeset_schema.md)

**方式 3：文档内 PATCH 标记**
- 在文档中使用 `:::PATCH` 标记指定修改位置
- 示例：
  ```markdown
  ::: PATCH
  将 Python 3.8 改为 Python 3.10
  :::
  ```

#### 三种反馈类型

**类型 1：全局语义修改**
- 应用于所有文档的规则或原则
- 示例：术语统一、风格调整、结构规范
- 处理：遍历所有文档应用规则

**类型 2：局部结构性重写**
- 重写特定章节或段落
- 示例：补充缺失内容、重组结构、增强说明
- 处理：基于上下文重新生成内容

**类型 3：直接内容改写（PATCH）**
- 精确指定位置的直接替换
- 示例：版本号更新、错误修正、链接修正
- 处理：执行精确替换并删除标记

#### 更新流程

**步骤 8.1：检测文档状态**
```bash
# 检查是否存在已生成的文档
ls -la .aigne/doc-smith/docs/
cat .aigne/doc-smith/output/document_structure.yaml
```

**步骤 8.2：识别输入类型**
- 自动检测或询问用户选择输入方式
- 解析用户提供的修改请求

**步骤 8.3：解析更新请求**
- 自然语言：分析并分类为三种反馈类型
- Changeset：提取全局修改、结构重写和 PATCH
- PATCH 标记：扫描文档查找所有标记

**步骤 8.4：应用修改**
按优先级执行：全局修改 → 结构重写 → PATCH
- 全局修改：应用规则到所有相关文档
- 结构重写：重新生成指定章节
- PATCH：执行精确替换并删除标记

**步骤 8.5：展示变更摘要**
```
已完成文档更新：

✓ 全局语义修改：3条规则应用到 12 个文档
✓ 结构重写：2个章节
✓ PATCH 应用：5处精确修改

修改的文件：
  - .aigne/doc-smith/docs/overview.md
  - .aigne/doc-smith/docs/getting-started.md
  - ... (共 12 个文件)
```

**详细指南：** 参见 [document_update_guide.md](references/document_update_guide.md)，包含：
- 三种反馈类型的详细说明和示例
- 三种输入方式的处理流程
- 完整的更新工作流程
- 常见场景和最佳实践
- 错误处理和冲突解决

## 输出结构

完成后：

```
.aigne/doc-smith/
├── output/
│   ├── user_intent.md             # 用户意图描述
│   └── document_structure.yaml    # 文档计划
└── docs/
    ├── overview.md                # 生成的文档
    ├── getting-started.md
    └── api/
        └── authentication.md
```

## 媒体资源

当工作区中存在媒体文件（图片、视频）时：

**发现：**
```bash
find . -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.gif" -o -name "*.mp4" \)
```

**在 markdown 中引用：**
```markdown
![架构图](../path/to/diagram.png)

<!-- 或相对于文档位置 -->
![截图](../../screenshots/ui.png)
```

**不要复制**媒体文件。直接从它们的工作区位置引用。

## 最佳实践

### 文档生成（步骤 1-7）

1. **始终基于用户意图**：先生成 `user_intent.md`，所有后续规划和生成都应参考它
2. **最小必要原则**：只生成用户意图中明确需要的文档，避免大而全
3. **多轮确认机制**：
   - 用户意图：自动生成后展示，支持多轮调整，用户确认后才规划结构
   - 文档结构：生成后展示，支持多轮调整，用户确认后才生成内容
4. **因项目而异**：小型项目扁平，中大型项目合理嵌套，以用户体验为准
5. **避免内容重复**：如果子文档之间或与父文档有重复，说明拆分不合理
6. **用户视角思考**：考虑用户的阅读习惯和查阅需求
   - 顺序任务（如快速开始）→ 单一文档
   - 独立模块（如不同 API 类别）→ 可以嵌套
7. **基于源文件结构**：如果工作区已有清晰的模块划分，可以映射到文档结构
8. **批量执行**：生成文档内容相对独立，优先批量执行，缩短执行时间
9. **使用源上下文**：从 `sourcePaths` 文件中提取实际内容
10. **保持一致性**：如果存在现有文档，遵循其风格
11. **验证路径**：确保所有文件路径和链接都正确
12. **检查 schema**：在生成文档之前验证 YAML 是否符合所需格式

### 文档更新（步骤 8）

13. **理解更新意图**：在应用修改前，明确修改的目的、影响范围和优先级
14. **正确分类反馈**：识别修改属于全局语义、结构重写还是直接 PATCH
15. **优先级处理**：按照"全局修改 → 结构重写 → PATCH"顺序执行，避免冲突
16. **保持一致性**：全局修改要应用到所有相关位置，不要遗漏
17. **批量应用修改**：全局修改一次性应用到所有文档，避免多次读写
18. **验证修改结果**：检查修改后的语法、链接和格式是否正确
19. **清晰的变更摘要**：展示修改的文档列表、变更类型和具体内容
20. **处理 PATCH 标记**：应用 PATCH 后必须删除标记，保持文档整洁
