# 文档更新执行流程

## 流程概览

```
检测文档状态 → 识别输入类型 → 解析修改请求 → 执行修改 → 展示摘要
```

## 步骤 1：检测文档状态

检查 `.aigne/doc-smith/docs/` 目录：
- **不存在** → 告知用户先执行文档生成流程
- **存在** → 继续更新流程

## 步骤 2：识别输入类型

根据用户消息判断输入类型：

| 输入类型 | 识别特征 | 下一步 |
|---------|---------|--------|
| **Changeset 文件** | 用户提供 `.md` 文件路径 | 读取文件，参见 [changeset-guide.md](changeset-guide.md) |
| **PATCH 标记** | 用户提到"PATCH 标记"或"应用 PATCH" | 扫描文档，参见 [patch-guide.md](patch-guide.md) |
| **自然语言** | 直接描述修改需求 | 分析并分类为下列类型之一 |

### 自然语言修改的分类

分析用户请求，识别修改类型：

**全局语义修改** - 跨多个文档的规则
- 关键词：`所有`、`统一`、`全部`、`删除`
- 示例：`"所有 API 改为 API 接口"`、`"删除所有第一人称"`

**局部结构重写** - 特定章节的补充或重组
- 关键词：`补充`、`添加`、`重写`、`重组`
- 示例：`"overview.md 补充项目背景"`、`"快速开始添加环境要求章节"`

**PATCH 级修改** - 用户提供精确的替换内容
- 特征：给出原文和修订文本
- 建议：引导用户使用 PATCH 标记格式

## 步骤 3：执行修改

### 执行优先级

严格按以下顺序执行，避免冲突：

```
1. 读取 Changeset（如果有）→ 建立全局约束
2. 扫描并执行所有 PATCH → 确定性变更
3. 应用全局语义修改 → 跨文档规则
4. 执行局部结构重写 → 章节级改写
5. 一致性检查 → 术语、链接、格式
```

### 冲突处理原则

当多个修改类型发生冲突时：

| 冲突场景 | 处理原则 |
|---------|---------|
| **PATCH vs 重写** | PATCH 先执行，重写在 PATCH 结果基础上进行 |
| **全局 vs 局部** | 局部（更具体）优先，在摘要中说明覆盖 |
| **澄清 vs 其他** | 澄清（需求理解）优先级最高 |

## 步骤 4：展示变更摘要

执行完成后，使用以下格式展示摘要：

```markdown
已完成文档更新：

✓ 全局语义修改：N 条规则应用到 M 个文档
  - [规则描述]（X 处修改）

✓ 局部结构重写：N 个章节
  - [文档名]: [章节名]

✓ PATCH 应用：N 处精确修改
  - [文档名]: [修改描述]

修改的文件：
  - [文件路径 1]
  - [文件路径 2]
  ...

[如有验收标准] 验收对齐：
  ☑ [标准 1]
  ☑ [标准 2]
  ☐ [未满足项] - [原因和建议]
```

## 执行要点

- **理解意图**：仔细分析修改请求，确定类型和范围
- **批量执行**：同类修改一次性处理，减少读写
- **保持一致**：全局修改必须应用到所有匹配位置
- **验证完整**：修改后检查语法、链接、术语一致性
- **清晰反馈**：详细列出所有修改，说明冲突取舍

## 错误处理

| 错误类型 | 处理方式 |
|---------|---------|
| **位置不存在** | 展示最接近匹配，询问确认 |
| **修改冲突** | 说明冲突原因，询问优先级 |
| **结构不匹配** | 展示当前结构，询问如何处理 |
| **信息不足** | 标注需澄清的问题，不要编造 |
